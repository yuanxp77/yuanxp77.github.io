<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工具集</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="enums.js"></script>
    <link rel="icon" type="image/png" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8Y2lyY2xlIGN4PSIxNiIgY3k9IjE2IiByPSIxNSIgZmlsbD0iIzAwN2FjYyIgc3Ryb2tlPSIjMDA1YTllIiBzdHJva2Utd2lkdGg9IjIiLz4KICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNiwgMTYpIj4KICAgIDxwYXRoIGQ9Ik0tOCwtMiBMLTYsLTIgTC02LC00IEwtNCwtNCBMLTQsLTYgTC0yLC02IEwtMiwtOCBMMiwtOCBMMiwtNiBMNCwtNiBMNCwtNCBMNiwtNCBMNiwtMiBMOCwtMiBMOCwyIEw2LDIgTDYsNCBMNCw0IEw0LDYgTDIsNiBMMiw4IEwtMiw4IEwtMiw2IEwtNCw2IEwtNCw0IEwtNiw0IEwtNiwyIEwtOCwyIFoiIGZpbGw9IiNmZmZmZmYiLz4KICAgIDxjaXJjbGUgY3g9IjAiIGN5PSIwIiByPSIzIiBmaWxsPSIjMDA3YWNjIi8+CiAgICA8Y2lyY2xlIGN4PSIwIiBjeT0iMCIgcj0iMSIgZmlsbD0iI2ZmZmZmZiIvPgogIDwvZz4KICA8Y2lyY2xlIGN4PSI4IiBjeT0iOCIgcj0iMSIgZmlsbD0iI2ZmZmZmZiIgb3BhY2l0eT0iMC43Ii8+CiAgPGNpcmNsZSBjeD0iMjQiIGN5PSI4IiByPSIxIiBmaWxsPSIjZmZmZmZmIiBvcGFjaXR5PSIwLjciLz4KICA8Y2lyY2xlIGN4PSI4IiBjeT0iMjQiIHI9IjEiIGZpbGw9IiNmZmZmZmYiIG9wYWNpdHk9IjAuNyIvPgogIDxjaXJjbGUgY3g9IjI0IiBjeT0iMjQiIHI9IjEiIGZpbGw9IiNmZmZmZmYiIG9wYWNpdHk9IjAuNyIvPgo8L3N2Zz4K">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1e1e1e;
            color: #cccccc;
            height: 100vh;
            overflow: hidden;
        }

        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #2d2d30;
        }

        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        /* 主容器 */
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #1e1e1e;
        }

        /* 侧边浮动快速打开区域 */
        .quick-open-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            width: 40px;
            height: 40px;
            transition: all 0.3s ease;
        }

        .quick-open-trigger {
            width: 40px;
            height: 40px;
            background: #007acc;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            user-select: none;
        }

        .quick-open-trigger:hover {
            background: #005a9e;
            transform: scale(1.1);
        }

        .quick-open-trigger.dragging {
            cursor: grabbing;
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .quick-open {
            position: absolute;
            top: 0;
            right: 0;
            background: #2d2d30;
            border: 1px solid #3c3c3c;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 200px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            opacity: 0;
            visibility: hidden;
            transform: translateX(20px) scale(0.9);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .quick-open-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #3c3c3c;
        }

        .quick-open-title {
            font-size: 12px;
            color: #888;
            font-weight: 500;
        }


        .quick-open.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(0) scale(1);
        }

        .quick-open-hint {
            position: absolute;
            top: 60px;
            right: 0;
            background: rgba(0, 122, 204, 0.1);
            color: #007acc;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            border: 1px dashed #007acc;
            animation: pulse 2s infinite;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .quick-open-hint.show {
            opacity: 1;
            visibility: visible;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .quick-btn {
            padding: 4px 8px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .quick-btn:hover {
            background: #005a9e;
            transform: translateY(-1px);
        }

        .quick-btn.close-all {
            background: #dc3545;
        }

        .quick-btn.close-all:hover {
            background: #c82333;
        }

        /* Tab栏 */
        .tab-bar {
            display: flex;
            background: #2d2d30;
            border-bottom: 1px solid #3c3c3c;
            overflow-x: auto;
            min-height: 32px;
            position: relative;
        }

        /* 统一的tab-编辑器容器 */
        .tab-editor-container {
            display: flex;
            height: 100vh;
            background: #1e1e1e;
            flex-wrap: wrap;
            align-content: flex-start;
            overflow: hidden;
            gap: 0;
            width: 100%;
        }

        .tab-editor-group {
            display: flex;
            flex-direction: column;
            flex: 0 0 auto;
            min-width: 200px;
            position: relative;
            overflow: hidden;
            height: 100vh;
            transition: all 0.3s ease;
        }


        .tab-editor-group:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 32px;
            right: 0;
            bottom: 0;
            width: 1px;
            background: #3c3c3c;
            z-index: 1;
        }
        


        .tab-editor-group .tab {
            flex: 0 0 auto;
            background: #2d2d30;
            border-bottom: 1px solid #3c3c3c;
        }

        .tab-editor-group .editor-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
            min-height: 0; /* 允许flex子元素收缩 */
            overflow: hidden; /* 防止内容溢出 */
        }

        .tab {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            background: #2d2d30;
            color: #cccccc;
            border: none;
            cursor: pointer;
            font-size: 11px;
            white-space: nowrap;
            min-width: 80px;
            max-width: 200px;
            position: relative;
            transition: all 0.2s ease;
        }

        .tab:hover {
            background: #3c3c3c;
        }

        .tab.active {
            background: #1e1e1e;
            color: #ffffff;
        }

        .tab:active {
            transform: scale(0.98);
        }

        .tab.flash {
            animation: tabFlash 0.6s ease-in-out;
        }

        @keyframes tabFlash {
            0% { background: #2d2d30; }
            25% { background: #007acc; }
            50% { background: #005a9e; }
            75% { background: #007acc; }
            100% { background: #2d2d30; }
        }

        .tab-close {
            margin-left: auto;
            padding: 2px 4px;
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 10px;
            border-radius: 2px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .tab-close:hover {
            background: #dc3545;
            color: white;
        }

        /* 编辑器容器 */
        .editor-container {
            flex: 1;
            display: flex;
            background: #1e1e1e;
            overflow: hidden;
            position: relative;
        }

        .editor-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
            min-width: 200px;
            position: relative;
            border-right: 1px solid #3c3c3c;
        }

        .editor-pane:last-child {
            border-right: none;
        }

        .editor-content {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
            background: #1e1e1e;
            contain: layout style;
            height: 0; /* 强制flex子元素使用overflow */
            min-height: 0; /* 允许flex子元素收缩 */
        }

        /* 分割线 */
        .splitter {
            width: 4px;
            background: #3c3c3c;
            cursor: col-resize;
            position: relative;
            transition: background 0.2s ease;
        }

        .splitter:hover {
            background: #007acc;
        }

        .splitter::before {
            content: '';
            position: absolute;
            top: 0;
            left: -2px;
            right: -2px;
            bottom: 0;
            background: transparent;
        }

        /* 工具样式 */
        .tool-container {
            max-width: 100%;
        }

        .tool-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #ffffff;
        }

        .input-group {
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .input-group label {
            display: block;
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
        }

        input[type="text"], textarea {
            width: 100% !important;
            padding: 8px 12px;
            background: #2d2d30;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            color: #cccccc;
            font-size: 13px;
            transition: all 0.3s ease;
            box-sizing: border-box !important;
            min-width: 200px !important;
            max-width: 100% !important;
            flex-shrink: 0 !important;
            flex-grow: 0 !important;
            flex-basis: auto !important;
            height: 36px !important;
        }

        textarea {
            resize: vertical;
            min-height: 80px !important;
            max-height: 300px;
            overflow-y: auto;
            height: 80px !important;
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #007acc;
        }

        /* 防止文本框尺寸变化 */
        .input-group {
            position: relative;
            overflow: hidden;
        }

        .input-group input, .input-group textarea {
            position: relative;
            z-index: 1;
            transform: translateZ(0);
            will-change: auto;
        }

        .result {
            background: #2d2d30;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            padding: 8px 50px 8px 12px;
            margin-top: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            color: #cccccc;
            word-break: break-all;
            min-height: 40px;
            position: relative;
            flex-shrink: 0;
        }
        
        /* 时区工具样式 */
        .tool-section {
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #d4d4d4;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 1px solid #3c3c3c;
        }
        
        .timezone-container {
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .timezone-group {
            margin-bottom: 12px;
            border: 1px solid #3c3c3c;
            border-radius: 6px;
            background: #2d2d30;
        }
        
        .timezone-group-header {
            background: #3c3c3c;
            padding: 8px 12px;
            font-size: 12px;
            color: #d4d4d4;
            font-weight: 600;
            border-radius: 6px 6px 0 0;
        }
        
        .timezone-item {
            display: flex;
            align-items: center;
            padding: 4px 6px;
            border-bottom: 1px solid #3c3c3c;
            transition: background-color 0.2s ease;
            gap: 4px;
            min-width: 0;
            width: 100%;
            box-sizing: border-box;
        }
        
        .timezone-item:last-child {
            border-bottom: none;
            border-radius: 0 0 6px 6px;
        }
        
        .timezone-item:hover {
            background: #3c3c3c;
        }
        
        .timezone-info {
            flex: 0 0 90px;
            font-size: 10px;
            color: #d4d4d4;
            font-weight: 500;
            text-align: left;
            min-width: 0;
            line-height: 1.1;
        }
        
        .timezone-time-container {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
            min-width: 0;
            position: relative;
        }
        
        .timezone-time {
            flex: 1;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 10px;
            color: #d4d4d4;
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            border-radius: 3px;
            padding: 3px 60px 3px 4px;
            text-align: left;
            width: 100%;
            box-sizing: border-box;
        }
        
        .timezone-copy {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            background: #007acc;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            font-size: 9px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            white-space: nowrap;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }
        
        .timezone-copy:hover {
            background: #005a9e;
        }
        
        .result-copy {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            background: #007acc;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            font-size: 9px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            white-space: nowrap;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }
        
        .result-copy:hover {
            background: #005a9e;
        }
        
        .input-with-button {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .input-with-button input {
            padding-right: 150px;
            width: 100%;
            box-sizing: border-box;
        }
        
        .input-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: #007acc;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            font-size: 9px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            white-space: nowrap;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }
        
        .input-button:nth-of-type(1) {
            right: 100px;
        }
        
        .input-button:nth-of-type(2) {
            right: 50px;
        }
        
        .input-button:nth-of-type(3) {
            right: 4px;
        }
        
        /* 时区输入框的按钮位置调整 */
        .timezone-input-buttons .input-button:nth-of-type(1) {
            right: 100px;
        }
        
        .timezone-input-buttons .input-button:nth-of-type(2) {
            right: 4px;  /* 复制按钮放到最右边 */
        }
        
        .timezone-input-buttons .input-button:nth-of-type(3) {
            right: 50px;  /* 清空按钮放到中间 */
        }
        
        /* 翻译工具按钮位置调整 */
        .translate-input-buttons .input-button:nth-of-type(1) {
            right: 50px;  /* 清空按钮放到左边 */
        }
        .translate-input-buttons .input-button:nth-of-type(2) {
            right: 4px;  /* 复制按钮放到最右边 */
        }
        
        /* Spex工具的清空按钮位置调整 */
        .spex-input-buttons .input-button {
            right: 4px;  /* 清空按钮放到最右边 */
        }
        
        /* 枚举工具的清空按钮位置调整 */
        .enum-input-buttons .input-button,
        .enum-query-buttons .input-button {
            right: 4px;  /* 清空按钮放到最右边 */
        }
        
        .input-button:hover {
            background: #005a9e;
        }

        .btn {
            padding: 6px 12px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .btn:hover {
            background: #005a9e;
            transform: translateY(-1px);
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn.secondary:hover {
            background: #545b62;
        }


        /* Toast通知 */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -60%);
            background: #2d2d30;
            color: #cccccc;
            padding: 16px 20px;
            border-radius: 8px;
            border: 1px solid #3c3c3c;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            font-size: 16px;
            z-index: 10000;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 400px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .toast.show {
            opacity: 1;
            transform: translate(-50%, -50%);
        }

        .toast-icon {
            display: inline-block;
            margin-right: 12px;
            font-size: 20px;
            font-weight: bold;
        }

        .toast.success .toast-icon::before {
            content: "✓";
            color: #28a745;
            text-shadow: 0 0 8px rgba(40, 167, 69, 0.5);
        }

        .toast.error .toast-icon::before {
            content: "✗";
            color: #dc3545;
            text-shadow: 0 0 8px rgba(220, 53, 69, 0.5);
        }

        .toast.info .toast-icon::before {
            content: "ℹ";
            color: #007acc;
            text-shadow: 0 0 8px rgba(0, 122, 204, 0.5);
        }

        /* 拖拽相关样式 */
        .tab-dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .tab-drag-over {
            border-left: 2px solid #007acc;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .quick-open {
                padding: 4px 8px;
                gap: 4px;
            }

            .quick-btn {
                padding: 3px 6px;
                font-size: 10px;
            }

            .tab {
                min-width: 60px;
                max-width: 120px;
                padding: 3px 6px;
                font-size: 10px;
            }

            .editor-content {
                padding: 8px;
            }

        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- 统一的tab-编辑器容器 -->
        <div class="tab-editor-container" id="tab-editor-container"></div>
    </div>

    <!-- 侧边浮动快速打开面板 -->
    <div class="quick-open-container" id="quick-open-container">
        <button class="quick-open-trigger" onclick="toggleQuickOpen()" id="quick-open-trigger" draggable="true">+</button>
        <div class="quick-open" id="quick-open">
            <div class="quick-open-header">
                <div class="quick-open-title">工具面板</div>
            </div>
            <button class="quick-btn" onclick="openTab('spex')">Business</button>
            <button class="quick-btn" onclick="openTab('tools')">Tools</button>
            <button class="quick-btn" onclick="openTab('diff')">Diff</button>
            <button class="quick-btn close-all" onclick="closeAllTabs()">关闭所有</button>
        </div>
        <div class="quick-open-hint" id="quick-open-hint">点击工具按钮打开</div>
    </div>

    <script>
        // 全局变量
        let openTabs = [];
        let draggedTab = null;
        let quickOpenVisible = false;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        
        // 布局持久化
        const LAYOUT_STORAGE_KEY = 'devtool_layout_state';
        
        // 时区数据
        const timezoneData = [
            { code: 'ID', name: 'Indonesia', timezone: 'Asia/Jakarta', offset: '+07:00', city: '雅加达' },
            { code: 'SG', name: 'Singapore', timezone: 'Asia/Singapore', offset: '+08:00', city: '新加坡' },
            { code: 'TW', name: 'Taiwan', timezone: 'Asia/Taipei', offset: '+08:00', city: '台北' },
            { code: 'TH', name: 'Thailand', timezone: 'Asia/Bangkok', offset: '+07:00', city: '曼谷' },
            { code: 'VN', name: 'Vietnam', timezone: 'Asia/Ho_Chi_Minh', offset: '+07:00', city: '胡志明市' },
            { code: 'MY', name: 'Malaysia', timezone: 'Asia/Kuala_Lumpur', offset: '+08:00', city: '吉隆坡' },
            { code: 'PH', name: 'Philippines', timezone: 'Asia/Manila', offset: '+08:00', city: '马尼拉' },
            { code: 'BR', name: 'Brazil', timezone: 'America/Sao_Paulo', offset: '-03:00', city: '圣保罗' },
            { code: 'CO', name: 'Colombia', timezone: 'America/Bogota', offset: '-05:00', city: '波哥大' },
            { code: 'CL', name: 'Chile', timezone: 'America/Santiago', offset: '-03:00', city: '圣地亚哥' },
            { code: 'MX', name: 'Mexico', timezone: 'America/Mexico_City', offset: '-06:00', city: '墨西哥城' },
            { code: 'AR', name: 'Argentina', timezone: 'America/Argentina/Buenos_Aires', offset: '-03:00', city: '布宜诺斯艾利斯' }
        ];
        
        // 保存布局状态到localStorage
        function saveLayoutState() {
            const layoutState = {
                openTabs: [...openTabs],
                timestamp: Date.now()
            };
            try {
                localStorage.setItem(LAYOUT_STORAGE_KEY, JSON.stringify(layoutState));
            } catch (error) {
                console.warn('无法保存布局状态:', error);
            }
        }
        
        // 获取tab的默认宽度占比
        function getTabDefaultWidth(tabName) {
            if (tabName === 'diff') {
                return 0.67; // diff工具默认占2/3宽度
            }
            return null; // 其他tab使用默认平分
        }
        
        // 从localStorage加载布局状态
        function loadLayoutState() {
            try {
                const saved = localStorage.getItem(LAYOUT_STORAGE_KEY);
                if (saved) {
                    const layoutState = JSON.parse(saved);
                    // 检查数据是否过期（7天）
                    const isExpired = Date.now() - layoutState.timestamp > 7 * 24 * 60 * 60 * 1000;
                    if (!isExpired && layoutState.openTabs && layoutState.openTabs.length > 0) {
                        return layoutState.openTabs;
                    }
                }
            } catch (error) {
                console.warn('无法加载布局状态:', error);
            }
            return null;
        }
        
        // 清除过期的布局状态
        function clearExpiredLayout() {
            try {
                const saved = localStorage.getItem(LAYOUT_STORAGE_KEY);
                if (saved) {
                    const layoutState = JSON.parse(saved);
                    const isExpired = Date.now() - layoutState.timestamp > 7 * 24 * 60 * 60 * 1000;
                    if (isExpired) {
                        localStorage.removeItem(LAYOUT_STORAGE_KEY);
                    }
                }
            } catch (error) {
                console.warn('清除过期布局状态失败:', error);
            }
        }
        

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 清除过期的布局状态
            clearExpiredLayout();
            
            // 尝试加载保存的布局状态
            const savedTabs = loadLayoutState();
            if (savedTabs && savedTabs.length > 0) {
                // 恢复保存的tab状态
                openTabs = [...savedTabs];
                updateDisplay();
            } else {
                // 默认打开Tools和Spex工具
                openTab('tools');
                openTab('spex');
            }
            
            // 3秒后显示提示（仅在没有tab时显示）
            setTimeout(() => {
                const hint = document.getElementById('quick-open-hint');
                if (hint && openTabs.length === 0) {
                    hint.classList.add('show');
                }
            }, 3000);
            
            // 初始化拖拽功能
            initQuickOpenDrag();
            
            // 点击外部自动收缩
            document.addEventListener('click', function(e) {
                const container = document.getElementById('quick-open-container');
                const quickOpen = document.getElementById('quick-open');
                if (quickOpenVisible && !container.contains(e.target)) {
                    toggleQuickOpen();
                }
            });
        });

        // 切换快速打开面板
        function toggleQuickOpen() {
            const quickOpen = document.getElementById('quick-open');
            const trigger = document.getElementById('quick-open-trigger');
            const hint = document.getElementById('quick-open-hint');
            
            quickOpenVisible = !quickOpenVisible;
            
            if (quickOpenVisible) {
                quickOpen.classList.add('show');
                trigger.textContent = '×';
                trigger.style.transform = 'rotate(45deg)';
                if (hint) {
                    hint.classList.remove('show');
                }
            } else {
                quickOpen.classList.remove('show');
                trigger.textContent = '+';
                trigger.style.transform = 'rotate(0deg)';
            }
        }

        // 初始化拖拽功能
        function initQuickOpenDrag() {
            const trigger = document.getElementById('quick-open-trigger');
            const container = document.getElementById('quick-open-container');
            
            if (!trigger || !container) return;
            
            // 鼠标按下开始拖拽
            trigger.addEventListener('mousedown', function(e) {
                if (e.button !== 0) return; // 只响应左键
                
                isDragging = true;
                trigger.classList.add('dragging');
                
                const rect = container.getBoundingClientRect();
                dragOffset.x = e.clientX - rect.left;
                dragOffset.y = e.clientY - rect.top;
                
                e.preventDefault();
            });
            
            // 鼠标移动拖拽
            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const x = e.clientX - dragOffset.x;
                const y = e.clientY - dragOffset.y;
                
                // 限制在视窗内
                const maxX = window.innerWidth - container.offsetWidth;
                const maxY = window.innerHeight - container.offsetHeight;
                
                container.style.left = Math.max(0, Math.min(x, maxX)) + 'px';
                container.style.top = Math.max(0, Math.min(y, maxY)) + 'px';
                container.style.right = 'auto';
            });
            
            // 鼠标释放结束拖拽
            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    trigger.classList.remove('dragging');
                }
            });
        }

        // 打开Tab
        function openTab(tabName) {
            if (openTabs.includes(tabName)) {
                // 如果tab已存在，闪烁提示并切换到该tab
                flashTab(tabName);
                switchTab(tabName);
                return;
            }

            // 添加新tab
            openTabs.push(tabName);
            updateDisplay();
            
            // 保存布局状态
            saveLayoutState();
            
            // 隐藏提示和关闭浮动面板
            const hint = document.getElementById('quick-open-hint');
            if (hint) {
                hint.classList.remove('show');
            }
            
            // 自动关闭浮动面板
            if (quickOpenVisible) {
                toggleQuickOpen();
            }
            
        }

        // 关闭Tab
        function closeTab(tabName) {
            const index = openTabs.indexOf(tabName);
            if (index > -1) {
                // 先播放淡出动画
                const tabGroup = document.querySelector(`.tab-editor-group[data-tab="${tabName}"]`);
                if (tabGroup) {
                    tabGroup.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
                    tabGroup.style.opacity = '0';
                    tabGroup.style.transform = 'scale(0.95)';
                }
                
                // 延迟更新布局，让动画完成
                setTimeout(() => {
                    // 停止该tab的动态更新
                    stopTimezoneUpdate(tabName);
                    
                    openTabs.splice(index, 1);
                    updateDisplay();
                    
                    // 保存布局状态
                    saveLayoutState();
                    
                    // 如果没有tab了，显示提示
                    if (openTabs.length === 0) {
                        const hint = document.getElementById('quick-open-hint');
                        if (hint) {
                            hint.classList.add('show');
                        }
                    }
                }, 200);
            }
        }

        // 关闭所有Tab
        function closeAllTabs() {
            // 停止所有动态更新
            Object.keys(timezoneUpdateIntervals).forEach(tabId => {
                stopTimezoneUpdate(tabId);
            });
            
            openTabs = [];
            updateDisplay();
            
            // 保存布局状态
            saveLayoutState();
            
            // 显示提示
            const hint = document.getElementById('quick-open-hint');
            if (hint) {
                hint.classList.add('show');
            }
            
            // 关闭浮动面板
            if (quickOpenVisible) {
                toggleQuickOpen();
            }
        }

        // 切换Tab
        function switchTab(tabName) {
            // 在VSCode模式中，所有tab都显示，但可以更新active状态
            updateTabActiveState(tabName);
        }

        // 更新tab的active状态
        function updateTabActiveState(activeTab) {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                if (tab.dataset.tab === activeTab) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
        }

        // 闪烁tab提示
        function flashTab(tabName) {
            const tab = document.querySelector(`.tab[data-tab="${tabName}"]`);
            if (tab) {
                // 添加闪烁动画
                tab.classList.add('flash');
                
                // 0.6秒后移除闪烁类
                setTimeout(() => {
                    tab.classList.remove('flash');
                }, 600);
            }
        }


        // 智能布局算法
        function optimizeLayout() {
            const container = document.getElementById('tab-editor-container');
            const groups = container.querySelectorAll('.tab-editor-group');
            
            if (groups.length === 0) return;
            
            // 使用requestAnimationFrame确保平滑过渡
            requestAnimationFrame(() => {
                const count = groups.length;
                const containerWidth = container.offsetWidth;
                
                // 检查是否有diff tab
                const hasDiff = Array.from(groups).some(g => g.dataset.tab === 'diff');
                
                // 重置所有样式
                groups.forEach(group => {
                    group.style.transition = 'all 0.3s ease';
                    group.style.flex = '';
                    group.style.minWidth = '';
                    group.style.maxWidth = '';
                    group.style.width = '';
                });
                
                if (count === 1) {
                    // 单个tab占满全宽
                    groups.forEach(group => {
                        group.style.flex = '1 1 100%';
                        group.style.minWidth = '100%';
                    });
                } else if (count === 2 && hasDiff) {
                    // 两个tab，其中一个是diff，diff占2/3
                    groups.forEach(group => {
                        if (group.dataset.tab === 'diff') {
                            group.style.flex = '0 0 66.67%';
                            group.style.minWidth = '66.67%';
                            group.style.maxWidth = '66.67%';
                        } else {
                            group.style.flex = '0 0 33.33%';
                            group.style.minWidth = '33.33%';
                            group.style.maxWidth = '33.33%';
                        }
                    });
                } else if (count === 2) {
                    // 两个tab各占50%
                    groups.forEach(group => {
                        group.style.flex = '1 1 50%';
                        group.style.minWidth = '50%';
                    });
                } else if (count === 3) {
                    // 三个tab各占33.33%
                    groups.forEach(group => {
                        group.style.flex = '1 1 33.33%';
                        group.style.minWidth = '33.33%';
                    });
                } else if (count === 4) {
                    // 四个tab各占25%
                    groups.forEach(group => {
                        group.style.flex = '1 1 25%';
                        group.style.minWidth = '25%';
                    });
                } else {
                    // 5+个tab：计算每行能放几个
                    const minWidth = 250; // 最小宽度
                    const maxPerRow = Math.floor(containerWidth / minWidth);
                    const actualPerRow = Math.min(maxPerRow, count);
                    const widthPercent = 100 / actualPerRow;
                    
                    groups.forEach((group, index) => {
                        group.style.flex = `1 1 ${widthPercent}%`;
                        group.style.minWidth = `${widthPercent}%`;
                        group.style.maxWidth = `${widthPercent}%`;
                    });
                }
                
                // 过渡完成后移除transition
                setTimeout(() => {
                    groups.forEach(group => {
                        group.style.transition = '';
                    });
                }, 300);
            });
        }

        // 更新显示
        function updateDisplay() {
            const container = document.getElementById('tab-editor-container');
            
            // 清空现有内容
            container.innerHTML = '';

            if (openTabs.length === 0) {
                // 显示空状态
                container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #888; font-size: 14px; flex: 1;">点击右上角按钮打开工具</div>';
                return;
            }

            // 为每个tab创建统一的tab-编辑器组
            openTabs.forEach((tab, index) => {
                // 创建tab-编辑器组容器
                const tabEditorGroup = document.createElement('div');
                tabEditorGroup.className = 'tab-editor-group';
                tabEditorGroup.dataset.tab = tab;
                // 不在这里设置flex，让optimizeLayout函数处理
                
                // 创建tab按钮
                const tabButton = document.createElement('div');
                tabButton.className = 'tab';
                if (index === 0) tabButton.classList.add('active');
                tabButton.textContent = getTabTitle(tab);
                tabButton.draggable = true;
                tabButton.dataset.tab = tab;
                
                // 添加关闭按钮
                const closeBtn = document.createElement('span');
                closeBtn.className = 'tab-close';
                closeBtn.innerHTML = '×';
                closeBtn.onclick = (e) => {
                    e.stopPropagation();
                    closeTab(tab);
                };
                
                tabButton.appendChild(closeBtn);
                tabButton.addEventListener('click', (e) => {
                    // 如果点击的是关闭按钮，不处理tab点击
                    if (e.target.classList.contains('tab-close')) {
                        return;
                    }
                    switchTab(tab);
                });
                
                // 鼠标中键关闭tab
                tabButton.addEventListener('mousedown', (e) => {
                    if (e.button === 1) { // 中键
                        e.preventDefault();
                        closeTab(tab);
                    }
                });
                
                // 拖拽事件
                tabButton.addEventListener('dragstart', handleTabDragStart);
                tabButton.addEventListener('dragend', handleTabDragEnd);
                tabButton.addEventListener('dragover', handleTabDragOver);
                tabButton.addEventListener('drop', handleTabDrop);
                
                // 创建编辑器面板
                const editorPane = document.createElement('div');
                editorPane.className = 'editor-pane';
                editorPane.dataset.tab = tab;
                
                const editorContent = document.createElement('div');
                editorContent.className = 'editor-content';
                editorContent.innerHTML = getTabContent(tab);
                
                editorPane.appendChild(editorContent);
                
                // 将tab和编辑器面板添加到组中
                tabEditorGroup.appendChild(tabButton);
                tabEditorGroup.appendChild(editorPane);
                
                
                // 将组添加到容器中
                container.appendChild(tabEditorGroup);
            });
            
            // 初始化工具
            setTimeout(() => {
                // 延迟优化布局，确保所有DOM更新完成
                setTimeout(() => {
                    optimizeLayout();
                }, 50);
                
                // 初始化时区工具
                setTimeout(() => {
                    openTabs.forEach(tab => {
                        if (tab === 'tools') {
                            // 找到对应的tabId
                            const tabGroup = document.querySelector(`.tab-editor-group[data-tab="${tab}"]`);
                            if (tabGroup) {
                                const editorPane = tabGroup.querySelector('.editor-pane');
                                if (editorPane) {
                                    const timezoneContainer = editorPane.querySelector('.timezone-container');
                                    if (timezoneContainer) {
                                        const tabId = timezoneContainer.id.split('-').pop();
                                        initTimezoneTool(tabId);
                                        const timezoneInput = editorPane.querySelector('[id^="timezone-timestamp-"]');
                                        if (timezoneInput) {
                                            setupMiddleClickPaste(timezoneInput);
                                        }
                                    }
                                }
                            }
                        } else if (tab === 'spex') {
                            // 找到对应的tabId
                            const tabGroup = document.querySelector(`.tab-editor-group[data-tab="${tab}"]`);
                            if (tabGroup) {
                                const editorPane = tabGroup.querySelector('.editor-pane');
                                if (editorPane) {
                                    const spexInput = editorPane.querySelector('[id^="spex-input-"]');
                                    const enumQueryInput = editorPane.querySelector('[id^="enum-query-"]');
                                    if (spexInput) {
                                        const tabId = spexInput.id.split('-').pop();
                                        setupSpexMiddleClickPaste(tabId);
                                    }
                                    if (enumQueryInput) {
                                        setupMiddleClickPaste(enumQueryInput);
                                    }
                                }
                            }
                        } else if (tab === 'tools') {
                            const tabGroup = document.querySelector(`.tab-editor-group[data-tab="${tab}"]`);
                            if (tabGroup) {
                                const editorPane = tabGroup.querySelector('.editor-pane');
                                if (editorPane) {
                                    const timezoneContainer = editorPane.querySelector('.timezone-container');
                                    if (timezoneContainer) {
                                        const tabId = timezoneContainer.id.split('-').pop();
                                        initTimezoneTool(tabId);
                                        const timezoneInput = editorPane.querySelector('[id^="timezone-timestamp-"]');
                                        if (timezoneInput) {
                                            setupMiddleClickPaste(timezoneInput);
                                        }
                                    }
                                    // 为中英翻译textareas设置中键粘贴
                                    setTimeout(() => {
                                        const englishInput = editorPane.querySelector('[id^="utils-english-"]');
                                        const chineseInput = editorPane.querySelector('[id^="utils-chinese-"]');
                                        if (englishInput) {
                                            setupMiddleClickPaste(englishInput);
                                            console.log('已设置英文输入框中键粘贴');
                                        }
                                        if (chineseInput) {
                                            setupMiddleClickPaste(chineseInput);
                                            console.log('已设置中文输入框中键粘贴');
                                        }
                                    }, 50);
                                }
                            }
                        }
                    });
                }, 200);
            }, 100);
        }

        // 获取Tab标题
        function getTabTitle(tabName) {
            const titles = {
                'spex': 'Business',
                'tools': 'Tools',
                'diff': 'Diff'
            };
            return titles[tabName] || tabName;
        }

        // 获取Tab内容
        function getTabContent(tabName) {
            const tabId = Math.random().toString(36).substr(2, 9);
            
            switch(tabName) {
                case 'spex':
                    return `
                        <div class="tool-container">
                            <div class="section-title">cmd转handler代码</div>
                            <div class="input-group">
                                <div class="input-with-button spex-input-buttons">
                                    <input type="text" id="spex-input-${tabId}" placeholder="输入cmd，如: a.b.c.get_product_info" oninput="debounceConvert('${tabId}')">
                                    <button class="input-button" onclick="clearSpexInput('${tabId}')">清空</button>
                                </div>
                            </div>
                            <div class="result" id="spex-result-${tabId}"></div>
                            
                            <!-- 枚举查询工具 -->
                            <div class="tool-section" style="margin-top: 30px; border-top: 1px solid #555; padding-top: 20px;">
                                <div class="section-title">枚举查询工具</div>
                                <div class="input-group">
                                    <label>查询值</label>
                                    <div class="input-with-button enum-query-buttons">
                                        <input type="text" id="enum-query-${tabId}" placeholder="输入要查询的值，如: 5" oninput="debounceQueryEnum('${tabId}')">
                                        <button class="input-button" onclick="clearEnumQuery('${tabId}')">清空</button>
                                    </div>
                                </div>
                                <div class="result" id="enum-result-${tabId}"></div>
                            </div>
                        </div>
                    `;
                case 'tools':
                    return `
                        <div class="tool-container">
                            <!-- 时区工具 -->
                            <div class="tool-section" style="margin-top: 20px;">
                                <div class="section-title">全球时区时间</div>
                                <div class="input-group">
                                    <div class="input-with-button timezone-input-buttons">
                                        <input type="text" id="timezone-timestamp-${tabId}" placeholder="输入时间戳或日期 (YYYY-MM-DD HH:mm:ss)" oninput="updateAllTimezones('${tabId}')">
                                        <button class="input-button" onclick="getCurrentTimezoneTime('${tabId}')">当前</button>
                                        <button class="input-button" onclick="copyTimezoneTimestamp('${tabId}')">复制</button>
                                        <button class="input-button" onclick="clearTimezoneInput('${tabId}')">清空</button>
                                    </div>
                                </div>
                                <div class="timezone-container" id="timezone-container-${tabId}">
                                    <!-- 时区列表将在这里动态生成 -->
                                </div>
                            </div>
                            
                            <!-- 中英翻译工具 -->
                            <div class="tool-section" style="margin-top: 30px; border-top: 1px solid #555; padding-top: 20px;">
                                <div class="section-title">中英翻译</div>
                                <div class="input-group">
                                    <label>中文</label>
                                    <div class="input-with-button translate-input-buttons">
                                        <textarea id="utils-chinese-${tabId}" rows="3" placeholder="输入中文..." oninput="debounceTranslate('${tabId}', 'zh')"></textarea>
                                        <button class="input-button" onclick="clearTranslate('${tabId}')">清空</button>
                                        <button class="input-button" onclick="copyTranslateText('${tabId}', 'chinese')">复制</button>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label>英文</label>
                                    <div class="input-with-button translate-input-buttons">
                                        <textarea id="utils-english-${tabId}" rows="3" placeholder="输入英文..." oninput="debounceTranslate('${tabId}', 'en')"></textarea>
                                        <button class="input-button" onclick="clearTranslate('${tabId}')">清空</button>
                                        <button class="input-button" onclick="copyTranslateText('${tabId}', 'english')">复制</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                case 'diff':
                    return `
                        <div class="tool-container" style="height: 100%; padding: 0;">
                            <iframe src="diff.html" style="width: 100%; height: 100%; border: none; border-radius: 4px;"></iframe>
                        </div>
                    `;
                default:
                    return `<div class="tool-container"><div class="tool-title">${tabName}</div><p>工具内容</p></div>`;
            }
        }

        // Spex转换功能
        function convertText(tabId) {
            const input = document.getElementById(`spex-input-${tabId}`);
            const result = document.getElementById(`spex-result-${tabId}`);
            
            if (input && result) {
                const text = input.value;
                if (text.trim()) {
                    const converted = toCamelCase(text);
                    result.innerHTML = `<div style="padding-right: 50px; min-height: 20px; display: flex; align-items: center;">${converted}</div><button class="result-copy" onclick="copyToClipboard('${tabId}')">复制</button>`;
                } else {
                    result.innerHTML = '';
                }
            }
        }

        // 防抖转换函数，避免初始化时的弹窗
        function debounceConvert(tabId) {
            clearTimeout(window.convertTimeout);
            window.convertTimeout = setTimeout(() => {
                convertText(tabId);
            }, 100);
        }

        function toCamelCase(str) {
            const lastDotIndex = str.lastIndexOf('.');
            if (lastDotIndex === -1) {
                return ') ' + str.replace(/_([a-z])/g, (match, letter) => letter.toUpperCase()) + '(ctx ';
            }
            
            const afterLastDot = str.substring(lastDotIndex + 1);
            const camelCase = afterLastDot.replace(/_([a-z])/g, (match, letter) => letter.toUpperCase())+ '(ctx';
            return ') ' + camelCase;
        }

        // 剪贴板功能

        async function copyToClipboard(tabId) {
            try {
                const result = document.getElementById(`spex-result-${tabId}`);
                if (result) {
                    // 获取文本内容，排除按钮文本
                    const textContent = result.textContent.replace('复制', '').trim();
                    if (textContent) {
                        await navigator.clipboard.writeText(textContent);
                        showToast('已复制到剪贴板', 'success');
                    } else {
                        showToast('没有内容可复制', 'error');
                    }
                }
            } catch (err) {
                showToast('复制失败', 'error');
            }
        }


        // 翻译功能
        function translateText(tabId, sourceLang) {
            const englishInput = document.getElementById(`utils-english-${tabId}`);
            const chineseInput = document.getElementById(`utils-chinese-${tabId}`);
            
            if (!englishInput || !chineseInput) return;
            
            const englishText = englishInput.value.trim();
            const chineseText = chineseInput.value.trim();
            
            // 如果两个框都有值，优先取中文
            if (englishText && chineseText) {
                performTranslation(chineseText, 'zh', 'en', englishInput);
                return;
            }
            
            // 如果只有英文有值，翻译为中文
            if (englishText && !chineseText) {
                performTranslation(englishText, 'en', 'zh', chineseInput);
                return;
            }
            
            // 如果只有中文有值，翻译为英文
            if (chineseText && !englishText) {
                performTranslation(chineseText, 'zh', 'en', englishInput);
                return;
            }
        }
        
        // 执行翻译
        function performTranslation(text, sourceLang, targetLang, targetInput) {
            if (!text.trim()) return;
            
            // 显示翻译中状态
            const originalValue = targetInput.value;
            targetInput.value = '翻译中...';
            targetInput.style.color = '#888';
            
            // 使用Google Translate API进行翻译
            const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLang}&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data && data[0] && data[0][0] && data[0][0][0]) {
                        const translatedText = data[0].map(item => item[0]).join('');
                        targetInput.value = translatedText;
                        targetInput.style.color = '#cccccc';
                    } else {
                        throw new Error('翻译失败');
                    }
                })
                .catch(error => {
                    console.error('翻译错误:', error);
                    targetInput.value = originalValue;
                    targetInput.style.color = '#cccccc';
                });
        }
        
        // 防抖翻译
        function debounceTranslate(tabId, sourceLang) {
            clearTimeout(window.translateTimeout);
            window.translateTimeout = setTimeout(() => {
                translateText(tabId, sourceLang);
            }, 500);
        }
        
        // 清空翻译内容
        function clearTranslate(tabId) {
            const englishInput = document.getElementById(`utils-english-${tabId}`);
            const chineseInput = document.getElementById(`utils-chinese-${tabId}`);
            
            if (englishInput) englishInput.value = '';
            if (chineseInput) chineseInput.value = '';
        }
        
        // 复制翻译文本
        async function copyTranslateText(tabId, type) {
            let text = '';
            if (type === 'chinese') {
                const input = document.getElementById(`utils-chinese-${tabId}`);
                if (input) text = input.value;
            } else if (type === 'english') {
                const input = document.getElementById(`utils-english-${tabId}`);
                if (input) text = input.value;
            }
            
            if (text.trim()) {
                try {
                    await navigator.clipboard.writeText(text);
                    showToast('复制成功', 'success');
                } catch (err) {
                    showToast('复制失败', 'error');
                }
            } else {
                showToast('没有内容可复制', 'warning');
            }
        }
        




        
        // 格式化日期为 YYYY-MM-DD HH:mm:ss
        function formatDate(date) {
            return date.getFullYear() + '-' + 
                   String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(date.getDate()).padStart(2, '0') + ' ' + 
                   String(date.getHours()).padStart(2, '0') + ':' + 
                   String(date.getMinutes()).padStart(2, '0') + ':' + 
                   String(date.getSeconds()).padStart(2, '0');
        }
        
        // 获取当前时区时间
        function getCurrentTimezoneTime(tabId) {
            const input = document.getElementById(`timezone-timestamp-${tabId}`);
            if (input) {
                const timestamp = Math.floor(Date.now() / 1000);
                input.value = timestamp.toString();
                updateAllTimezones(tabId);
                showToast('已获取当前时间', 'success');
            }
        }

        // 检查剪贴板内容是否为时间戳或日期
        function isTimestampOrDate(text) {
            if (!text || typeof text !== 'string') return false;
            
            const trimmed = text.trim();
            
            // 检查是否为纯数字时间戳（10位或13位）
            if (/^\d{10}$/.test(trimmed)) {
                return { type: 'timestamp', value: trimmed };
            }
            if (/^\d{13}$/.test(trimmed)) {
                return { type: 'timestamp', value: Math.floor(parseInt(trimmed) / 1000).toString() };
            }
            
            // 检查是否为日期格式
            const datePatterns = [
                /^\d{4}-\d{2}-\d{2}$/, // YYYY-MM-DD
                /^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/, // YYYY-MM-DD HH:mm:ss
                /^\d{4}\/\d{2}\/\d{2}$/, // YYYY/MM/DD
                /^\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}:\d{2}$/, // YYYY/MM/DD HH:mm:ss
                /^\d{2}\/\d{2}\/\d{4}$/, // MM/DD/YYYY
                /^\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}:\d{2}$/, // MM/DD/YYYY HH:mm:ss
            ];
            
            for (const pattern of datePatterns) {
                if (pattern.test(trimmed)) {
                    return { type: 'date', value: trimmed };
                }
            }
            
            return false;
        }

        // 为所有输入框添加鼠标中键粘贴功能
        function setupMiddleClickPaste(input) {
            if (!input) return;
            
            // 移除可能已存在的监听器
            input.removeEventListener('mousedown', input._middleClickHandler);
            
            // 创建新的处理函数
            input._middleClickHandler = async (e) => {
                if (e.button === 1) { // 中键
                    e.preventDefault();
                    e.stopPropagation();
                    try {
                        const clipboardText = await navigator.clipboard.readText();
                        if (clipboardText) {
                            // 对于textarea，保留光标位置插入
                            if (input.tagName.toLowerCase() === 'textarea') {
                                const start = input.selectionStart;
                                const end = input.selectionEnd;
                                const text = input.value;
                                input.value = text.substring(0, start) + clipboardText + text.substring(end);
                                input.selectionStart = input.selectionEnd = start + clipboardText.length;
                            } else {
                                input.value = clipboardText;
                            }
                            // 触发input事件以更新相关功能
                            const event = new Event('input', { bubbles: true });
                            input.dispatchEvent(event);
                        }
                    } catch (err) {
                        console.warn('无法读取剪贴板:', err);
                    }
                }
            };
            
            input.addEventListener('mousedown', input._middleClickHandler);
        }

        // 为spex工具设置中键粘贴功能
        function setupSpexMiddleClickPaste(tabId) {
            const input = document.getElementById(`spex-input-${tabId}`);
            if (!input) return;
            
            setupMiddleClickPaste(input);
        }
        
        // 复制时区时间戳
        function copyTimezoneTimestamp(tabId) {
            const input = document.getElementById(`timezone-timestamp-${tabId}`);
            if (input && input.value.trim()) {
                navigator.clipboard.writeText(input.value).then(() => {
                    showToast('已复制时间戳', 'success');
                });
            } else {
                showToast('输入框为空', 'error');
            }
        }
        
        // 清空时区输入
        function clearTimezoneInput(tabId) {
            const input = document.getElementById(`timezone-timestamp-${tabId}`);
            if (input) {
                input.value = '';
                updateAllTimezones(tabId);
            }
        }
        
        // 清空Spex输入
        function clearSpexInput(tabId) {
            const input = document.getElementById(`spex-input-${tabId}`);
            const result = document.getElementById(`spex-result-${tabId}`);
            if (input) {
                input.value = '';
                if (result) {
                    result.innerHTML = '';
                }
            }
        }
        
        // 枚举工具功能
        let enumData = {}; // 存储解析的枚举数据
        
        
        // 查询枚举值
        function queryEnumValue(tabId) {
            const query = document.getElementById(`enum-query-${tabId}`);
            const result = document.getElementById(`enum-result-${tabId}`);
            
            if (!query || !result) return;
            
            const value = query.value.trim();
            if (!value) {
                result.innerHTML = '';
                return;
            }
            
            // 检查是否已加载预定义枚举数据
            if (typeof window.PREDEFINED_ENUMS === 'undefined') {
                result.innerHTML = '<div style="color: #ff6b6b;">❌ 预定义枚举数据未加载，请检查enums.js文件</div>';
                return;
            }
            
            // 在所有预定义枚举中搜索
            let foundResults = [];
            let allAvailableValues = [];
            
            Object.keys(window.PREDEFINED_ENUMS).forEach(enumName => {
                const enumData = window.PREDEFINED_ENUMS[enumName];
                if (enumData[value]) {
                    foundResults.push({
                        enumName: enumName,
                        value: value,
                        meaning: enumData[value]
                    });
                }
                // 收集所有可用值
                Object.keys(enumData).forEach(key => {
                    allAvailableValues.push(`${key}(${enumName})`);
                });
            });
            
            if (foundResults.length > 0) {
                let html = '<div style="color: #4CAF50; font-size: 16px; font-weight: bold; margin-bottom: 10px;">✅ 查询结果:</div>';
                foundResults.forEach(result => {
                    html += `<div style="background: #2d2d30; padding: 10px; border-radius: 4px; margin-bottom: 8px; font-family: monospace; cursor: pointer; border: 1px solid #555; transition: all 0.2s ease;" 
                             onmouseover="this.style.borderColor='#007acc'; this.style.background='#3d3d3d'" 
                             onmouseout="this.style.borderColor='#555'; this.style.background='#2d2d30'"
                             onclick="showEnumDetails('${result.enumName}', '${tabId}')">
                        <div style="color: #4CAF50; font-weight: bold;">${result.enumName}</div>
                        <div style="color: #cccccc;">${result.value} = ${result.meaning}</div>
                    </div>`;
                });
                result.innerHTML = html;
            } else {
                result.innerHTML = `<div style="color: #ff6b6b;">
                    <div>❌ 未找到值 ${value}</div>
                    <div style="margin-top: 10px; color: #888; font-size: 12px;">可用值示例: ${allAvailableValues.slice(0, 10).join(', ')}${allAvailableValues.length > 10 ? '...' : ''}</div>
                </div>`;
            }
        }
        
        
        // 清空枚举查询
        function clearEnumQuery(tabId) {
            const input = document.getElementById(`enum-query-${tabId}`);
            const result = document.getElementById(`enum-result-${tabId}`);
            if (input) {
                input.value = '';
            }
            if (result) {
                result.innerHTML = '';
            }
        }
        
        // 显示枚举详情浮窗
        function showEnumDetails(enumName, tabId) {
            // 检查是否已加载预定义枚举数据
            if (typeof window.PREDEFINED_ENUMS === 'undefined') {
                alert('预定义枚举数据未加载');
                return;
            }
            
            const enumData = window.PREDEFINED_ENUMS[enumName];
            if (!enumData) {
                alert('未找到枚举: ' + enumName);
                return;
            }
            
            // 创建浮窗
            const modal = document.createElement('div');
            modal.id = 'enum-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: #2d2d30;
                border: 1px solid #555;
                border-radius: 8px;
                padding: 20px;
                max-width: 500px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            `;
            
            let html = `
                <div style="margin-bottom: 15px;">
                    <h3 style="color: #4CAF50; margin: 0; font-size: 18px;">${enumName}</h3>
                </div>
                <div style="background: #1e1e1e; padding: 15px; border-radius: 4px; font-family: monospace; max-height: 400px; overflow-y: auto;">
            `;
            
            // 按数值排序显示所有枚举值
            Object.keys(enumData).sort((a, b) => parseInt(a) - parseInt(b)).forEach(key => {
                html += `<div style="padding: 5px 0; border-bottom: 1px solid #333; display: flex; justify-content: space-between;">
                    <span style="color: #4CAF50; font-weight: bold;">${key}</span>
                    <span style="color: #cccccc;">${enumData[key]}</span>
                </div>`;
            });
            
            html += `
                </div>
                <div style="margin-top: 15px; text-align: center;">
                    <button onclick="copyEnumToClipboard('${enumName}')" style="background: #007acc; color: white; border: none; border-radius: 4px; padding: 8px 16px; cursor: pointer; margin-right: 10px;">复制枚举</button>
                    <button onclick="closeEnumModal()" style="background: #666; color: white; border: none; border-radius: 4px; padding: 8px 16px; cursor: pointer;">关闭</button>
                </div>
            `;
            
            modalContent.innerHTML = html;
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // 点击背景关闭浮窗
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeEnumModal();
                }
            });
        }
        
        // 关闭枚举浮窗
        function closeEnumModal() {
            const modal = document.getElementById('enum-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // 复制枚举到剪贴板
        function copyEnumToClipboard(enumName) {
            if (typeof window.PREDEFINED_ENUMS === 'undefined') {
                alert('预定义枚举数据未加载');
                return;
            }
            
            const enumData = window.PREDEFINED_ENUMS[enumName];
            if (!enumData) {
                alert('未找到枚举: ' + enumName);
                return;
            }
            
            // 生成枚举代码
            let code = `const ${enumName} = {\n`;
            Object.keys(enumData).sort((a, b) => parseInt(a) - parseInt(b)).forEach(key => {
                code += `    ${key}: '${enumData[key]}',\n`;
            });
            code += '};';
            
            navigator.clipboard.writeText(code).then(() => {
                showToast('枚举代码已复制到剪贴板', 'success');
            }).catch(() => {
                alert('复制失败，请手动复制');
            });
        }
        
        
        
        function debounceQueryEnum(tabId) {
            clearTimeout(window.queryEnumTimeout);
            window.queryEnumTimeout = setTimeout(() => {
                queryEnumValue(tabId);
            }, 300);
        }

        
        function copyResult(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                const text = element.textContent.replace('复制', '').trim();
                navigator.clipboard.writeText(text).then(() => {
                    showToast('已复制结果', 'success');
                });
            }
        }
        
        
        
        // 更新结果内容的通用函数
        function updateResultContent(result, content, tabId, resultId) {
            const textNode = result.childNodes[0];
            if (textNode && textNode.nodeType === Node.TEXT_NODE) {
                textNode.textContent = content;
            } else {
                result.innerHTML = content + '<button class="result-copy" onclick="copyResult(\'' + resultId + '-' + tabId + '\')">复制</button>';
            }
        }



        // 拖拽功能
        function handleTabDragStart(e) {
            draggedTab = e.target.dataset.tab;
            e.target.classList.add('tab-dragging');
            
            // 同时拖拽对应的tab-编辑器组
            const tabEditorGroup = document.querySelector(`.tab-editor-group[data-tab="${draggedTab}"]`);
            if (tabEditorGroup) {
                tabEditorGroup.style.opacity = '0.5';
                tabEditorGroup.style.transform = 'rotate(2deg)';
            }
        }

        function handleTabDragEnd(e) {
            e.target.classList.remove('tab-dragging');
            
            // 恢复tab-编辑器组样式
            const tabEditorGroup = document.querySelector(`.tab-editor-group[data-tab="${draggedTab}"]`);
            if (tabEditorGroup) {
                tabEditorGroup.style.opacity = '1';
                tabEditorGroup.style.transform = 'none';
            }
            
            draggedTab = null;
        }

        function handleTabDragOver(e) {
            e.preventDefault();
            const targetTab = e.target.closest('.tab');
            if (targetTab && targetTab.dataset.tab !== draggedTab) {
                targetTab.classList.add('tab-drag-over');
                
                // 同时高亮对应的tab-编辑器组
                const targetTabEditorGroup = document.querySelector(`.tab-editor-group[data-tab="${targetTab.dataset.tab}"]`);
                if (targetTabEditorGroup) {
                    targetTabEditorGroup.style.border = '2px dashed #007acc';
                }
            }
        }

        function handleTabDrop(e) {
            e.preventDefault();
            const targetTab = e.target.closest('.tab');
            if (targetTab && draggedTab) {
                const draggedIndex = openTabs.indexOf(draggedTab);
                const targetIndex = openTabs.indexOf(targetTab.dataset.tab);
                
                if (draggedIndex !== -1 && targetIndex !== -1) {
                    // 重新排列数组
                    const draggedItem = openTabs.splice(draggedIndex, 1)[0];
                    openTabs.splice(targetIndex, 0, draggedItem);
                    updateDisplay();
                }
            }
            
            // 清理样式
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('tab-drag-over');
            });
            
            document.querySelectorAll('.tab-editor-group').forEach(group => {
                group.style.border = 'none';
            });
        }


        // Toast通知
        function showToast(message, type = 'info', duration = 2000) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span class="toast-icon"></span><span style="font-weight: 500;">${message}</span>`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 50);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 400);
            }, duration);
        }
        
        // 时区工具功能
        function initTimezoneTool(tabId) {
            const container = document.getElementById(`timezone-container-${tabId}`);
            if (!container) return;
            
            // 启动动态更新
            startTimezoneUpdate(tabId);
            
            // 按UTC偏移量分组，每个偏移量显示所有地区
            const groupedTimezones = {};
            timezoneData.forEach(tz => {
                if (!groupedTimezones[tz.offset]) {
                    groupedTimezones[tz.offset] = [];
                }
                groupedTimezones[tz.offset].push(tz);
            });
            
            // 生成时区列表
            let html = '';
            Object.keys(groupedTimezones).sort((a, b) => {
                // 按UTC偏移量排序
                const offsetA = parseInt(a.replace(':', ''));
                const offsetB = parseInt(b.replace(':', ''));
                return offsetB - offsetA;
            }).forEach(offset => {
                const timezones = groupedTimezones[offset];
                // 收集所有地区缩写
                const codes = timezones.map(tz => tz.code).join(', ');
                const tz = timezones[0]; // 使用第一个时区作为代表
                const timeId = `time-${tabId}-${tz.code}`;
                html += `
                    <div class="timezone-item">
                        <div class="timezone-info">
                            <div>${codes}</div>
                            <div style="font-size: 10px; color: #888; margin-top: 2px;">(UTC${offset})</div>
                        </div>
                        <div class="timezone-time-container">
                            <input type="text" class="timezone-time" id="${timeId}" 
                                   placeholder="YYYY-MM-DD HH:mm:ss" 
                                   oninput="updateAllTimes('${tabId}', '${tz.timezone}', '${timeId}')">
                            <button class="timezone-copy" onclick="copyTimezoneTime('${timeId}')">复制</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // 设置默认时间（当前时间）
            setTimeout(() => {
                updateAllTimezones(tabId);
            }, 100);
        }
        
        // 从时间戳输入更新所有时区
        function updateAllTimezones(tabId) {
            const timestampInput = document.getElementById(`timezone-timestamp-${tabId}`);
            if (!timestampInput) return;
            
            let baseTime;
            const inputValue = timestampInput.value.trim();
            
            if (!inputValue) {
                // 如果输入为空，使用当前时间
                baseTime = new Date();
            } else {
                // 尝试解析输入
                if (/^\d+$/.test(inputValue)) {
                    // 纯数字，当作时间戳处理
                    baseTime = new Date(parseInt(inputValue) * 1000);
                } else {
                    // 当作日期字符串处理
                    baseTime = new Date(inputValue);
                }
                
                if (isNaN(baseTime.getTime())) {
                    return; // 无效时间，不更新
                }
            }
            
            // 更新所有时区的时间
            timezoneData.forEach(tz => {
                const timeInput = document.getElementById(`time-${tabId}-${tz.code}`);
                if (timeInput) {
                    // 使用Intl.DateTimeFormat正确计算时区时间
                    const formatter = new Intl.DateTimeFormat('sv-SE', {
                        timeZone: tz.timezone,
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                    const formattedTime = formatter.format(baseTime);
                    timeInput.value = formattedTime;
                }
            });
        }
        
        // 更新所有时区时间（从单个时区输入）
        function updateAllTimes(tabId, sourceTimezone, sourceTimeId) {
            const sourceInput = document.getElementById(sourceTimeId);
            if (!sourceInput || !sourceInput.value.trim()) return;
            
            try {
                // 解析输入的时间，将其视为源时区的本地时间
                const inputTimeStr = sourceInput.value;
                if (!/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(inputTimeStr)) {
                    return; // 格式不正确，不处理
                }
                
                // 使用更可靠的方法：创建一个在源时区的特定时间点
                // 将输入时间解析为各个部分
                const [datePart, timePart] = inputTimeStr.split(' ');
                const [year, month, day] = datePart.split('-').map(Number);
                const [hour, minute, second] = timePart.split(':').map(Number);
                
                // 创建一个临时的UTC时间，然后调整到源时区
                const tempUtc = new Date(Date.UTC(year, month - 1, day, hour, minute, second));
                
                // 获取源时区在该日期的偏移量
                const sourceOffsetMs = getTimezoneOffset(sourceTimezone, tempUtc);
                
                // 计算真正的UTC时间
                const realUtcTime = new Date(tempUtc.getTime() - sourceOffsetMs);
                
                // 更新时间戳输入框
                const timestampInput = document.getElementById(`timezone-timestamp-${tabId}`);
                if (timestampInput) {
                    const timestamp = Math.floor(realUtcTime.getTime() / 1000);
                    timestampInput.value = timestamp.toString();
                }
                
                // 使用真正的UTC时间更新所有时区
                timezoneData.forEach(tz => {
                    const timeInput = document.getElementById(`time-${tabId}-${tz.code}`);
                    if (timeInput) {
                        // 使用Intl.DateTimeFormat正确计算时区时间
                        const formatter = new Intl.DateTimeFormat('sv-SE', {
                            timeZone: tz.timezone,
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false
                        });
                        const formattedTime = formatter.format(realUtcTime);
                        timeInput.value = formattedTime;
                    }
                });
            } catch (error) {
                console.warn('时间更新失败:', error);
            }
        }
        
        // 获取指定时区在特定时间的偏移量（毫秒）
        function getTimezoneOffset(timezone, date) {
            // 获取UTC时间的各个部分
            const utcYear = date.getUTCFullYear();
            const utcMonth = date.getUTCMonth();
            const utcDate = date.getUTCDate();
            const utcHours = date.getUTCHours();
            const utcMinutes = date.getUTCMinutes();
            const utcSeconds = date.getUTCSeconds();
            
            // 创建一个表示UTC时间的Date对象
            const utcTime = new Date(Date.UTC(utcYear, utcMonth, utcDate, utcHours, utcMinutes, utcSeconds));
            
            // 使用Intl.DateTimeFormat获取该时间在指定时区的表示
            const formatter = new Intl.DateTimeFormat('en-CA', {
                timeZone: timezone,
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            
            const parts = formatter.formatToParts(utcTime);
            const localYear = parseInt(parts.find(p => p.type === 'year').value);
            const localMonth = parseInt(parts.find(p => p.type === 'month').value) - 1;
            const localDay = parseInt(parts.find(p => p.type === 'day').value);
            const localHour = parseInt(parts.find(p => p.type === 'hour').value);
            const localMinute = parseInt(parts.find(p => p.type === 'minute').value);
            const localSecond = parseInt(parts.find(p => p.type === 'second').value);
            
            // 创建本地时间的Date对象（但当作UTC处理）
            const localAsUtc = new Date(Date.UTC(localYear, localMonth, localDay, localHour, localMinute, localSecond));
            
            // 偏移量 = 本地时间 - UTC时间
            return localAsUtc.getTime() - utcTime.getTime();
        }
        
        // 复制时区时间
        function copyTimezoneTime(timeId) {
            const timeInput = document.getElementById(timeId);
            if (timeInput && timeInput.value) {
                navigator.clipboard.writeText(timeInput.value).then(() => {
                    showToast('时间已复制到剪贴板', 'success');
                }).catch(() => {
                    showToast('复制失败', 'error');
                });
            }
        }
        
        // 动态更新时区时间
        let timezoneUpdateIntervals = {};
        
        function startTimezoneUpdate(tabId) {
            // 清除之前的定时器
            if (timezoneUpdateIntervals[tabId]) {
                clearInterval(timezoneUpdateIntervals[tabId]);
            }
            
            // 每5秒更新一次时间
            timezoneUpdateIntervals[tabId] = setInterval(() => {
                updateTimezoneDisplay(tabId);
            }, 5000);
        }
        
        function stopTimezoneUpdate(tabId) {
            if (timezoneUpdateIntervals[tabId]) {
                clearInterval(timezoneUpdateIntervals[tabId]);
                delete timezoneUpdateIntervals[tabId];
            }
        }
        
        function updateTimezoneDisplay(tabId) {
            const container = document.getElementById(`timezone-container-${tabId}`);
            if (!container) return;
            
            // 检查是否有用户正在编辑时间
            const activeElement = document.activeElement;
            const isEditing = activeElement && activeElement.classList.contains('timezone-time');
            
            // 如果用户正在编辑，不自动更新
            if (isEditing) return;
            
            // 检查时间戳输入框是否有值
            const timestampInput = document.getElementById(`timezone-timestamp-${tabId}`);
            if (timestampInput && timestampInput.value.trim()) {
                // 如果有时间戳输入，使用该时间作为基准
                updateAllTimezones(tabId);
            } else {
                // 否则使用当前时间
                const now = new Date();
                timezoneData.forEach(tz => {
                    const timeInput = document.getElementById(`time-${tabId}-${tz.code}`);
                    if (timeInput) {
                        const formatter = new Intl.DateTimeFormat('sv-SE', {
                            timeZone: tz.timezone,
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false
                        });
                        const formattedTime = formatter.format(now);
                        timeInput.value = formattedTime;
                    }
                });
            }
        }
    </script>
</body>
</html>